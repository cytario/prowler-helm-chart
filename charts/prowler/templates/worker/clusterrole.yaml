{{- if .Values.worker.rbac.create -}}
# Kubernetes RBAC permissions for Prowler to scan the cluster
# Reference: https://docs.prowler.com/projects/prowler-open-source/en/latest/tutorials/prowler-app/#step-44-kubernetes-credentials
#
# These permissions allow Prowler workers to perform security scans of the Kubernetes cluster.
# If you don't plan to scan Kubernetes resources, you can disable this by setting:
#   worker.rbac.create: false
#
# The ClusterRole grants read-only access to security-relevant resources:
# - pods, configmaps, nodes, namespaces: for configuration and deployment analysis
# - RBAC resources: for permission and access control auditing
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "prowler.fullname" . }}-worker
  labels:
    {{- include "prowler.labels" . | nindent 4 }}
rules:
# Core API resources
- apiGroups: [""]
  resources: ["pods", "configmaps", "nodes", "namespaces", "services", "serviceaccounts"]
  verbs: ["get", "list"]
# RBAC resources for access control auditing
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["clusterrolebindings", "rolebindings", "clusterroles", "roles"]
  verbs: ["get", "list"]
# Apps resources for deployment scanning
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
  verbs: ["get", "list"]
# Networking resources
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies", "ingresses"]
  verbs: ["get", "list"]
# Policy resources
- apiGroups: ["policy"]
  resources: ["podsecuritypolicies", "poddisruptionbudgets"]
  verbs: ["get", "list"]
{{- with .Values.worker.rbac.rules }}
{{- toYaml . | nindent 0 }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "prowler.fullname" . }}-worker
  labels:
    {{- include "prowler.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "prowler.fullname" . }}-worker
subjects:
- kind: ServiceAccount
  name: {{ include "prowler.worker.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
{{- end -}}
